- name: Get Ascender Login info
  hosts: ascender
  environment:
    K8S_AUTH_KUBECONFIG: "{{ K8S_AUTH_KUBECONFIG }}"

  tasks:
    - name: Get the Admin password
      kubernetes.core.k8s_info:
        api: v1
        kind: Secret
        name: ascender-admin-password
        namespace: "{{ ASCENDER_NAMESPACE }}"
      register: ascender_password

    - name: Get the Service Port
      kubernetes.core.k8s_info:
        api: v1
        kind: Service
        name: ascender-service
        namespace: "{{ ASCENDER_NAMESPACE }}"
      register: ascender_service

    - name: Store Results
      ansible.builtin.set_fact:
         ascender_username: admin
         ascender_password: "{{ ascender_password.resources[0].data.password | b64decode }}"
         ascender_port: "{{ ascender_service.resources[0].spec.ports[0].nodePort }}"

- hosts: localhost
  gather_facts: no
  connection: local
  pre_tasks:
    - name: Set Ascender IP and Port
      ansible.builtin.set_fact:
        ascender_ip: "{{ hostvars[groups['ascender'][0]].ansible_host }}"
        ascender_password: "{{ hostvars[groups['ascender'][0]].ascender_password }}"
        ascender_port: "{{ hostvars[groups['ascender'][0]].ascender_port}}"

  roles:
    - setup_playbooks